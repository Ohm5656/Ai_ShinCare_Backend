# ==================================================================================================
# main.py ‚Äî GlowbieBell + Dr.SkinAI Backend
# --------------------------------------------------------------------------------------------------
# ‚úÖ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡πâ‡∏≤ 3 ‡∏°‡∏∏‡∏° ‚Üí ‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å analyzers ‡∏ó‡∏±‡πâ‡∏á 7
# ‚úÖ ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô skin_fusion_model.py (‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å=‡∏î‡∏µ)
# ‚úÖ ‡πÉ‡∏ä‡πâ OpenAI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡πÄ‡∏ä‡∏¥‡∏á‡∏†‡∏≤‡∏©‡∏≤ (DrSkinAI)
# ‚úÖ ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö frontend ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥
# ==================================================================================================

from fastapi import FastAPI, HTTPException, UploadFile, Form
from fastapi.responses import FileResponse
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
import requests, os, cv2
from PIL import Image
import numpy as np
from dotenv import load_dotenv

# üîπ Analyzer imports
from analyzers.wrinkles_ffhq import score_wrinkles_multi
from analyzers.sagging_facemesh import score_sagging
from analyzers.pigmentation_vit import score_pigmentation_multi
from analyzers.acne_vit import score_acne_multi
from analyzers.redness_vit_or_hemo import score_redness_multi
from analyzers.texture_unet_or_opencv import score_texture
from analyzers.tone_lab import score_tone_multiview
from skin_fusion_model import SkinFusion, Profile
import base64
import io


# ===================================================================================
# üîπ ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πà‡∏≤ API Key ‡∏à‡∏≤‡∏Å .env
# ===================================================================================
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
OPENAI_API_URL = "https://api.openai.com/v1/chat/completions"

print("‚úÖ DEBUG: Loaded OPENAI_API_KEY =", OPENAI_API_KEY[:10] + "..." if OPENAI_API_KEY else "‚ùå None")

# ===================================================================================
# üîπ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ FastAPI App + CORS
# ===================================================================================
app = FastAPI(title="GlowbieBell Backend", version="2.0.0")

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://aishincarefrontend-production.up.railway.app",
        "http://localhost:5173",
        "http://localhost:3000",
        "*"
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ===================================================================================
# üîπ ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
# ===================================================================================
@app.get("/")
async def root():
    return {"message": "ü©∫ GlowbieBell x DrSkinAI backend is running successfully."}

# ===================================================================================
# üîπ Model ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Chatbot ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ)
# ===================================================================================
class PromptRequest(BaseModel):
    prompt: str

@app.post("/ask-ai")
async def ask_ai(request: PromptRequest):
    """‡∏ñ‡∏≤‡∏° Dr.SkinAI ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ"""
    if not OPENAI_API_KEY:
        raise HTTPException(status_code=500, detail="‚ùå Missing OPENAI_API_KEY")

    system_prompt = """
        ## 1. ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏´‡∏•‡∏±‡∏Å: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Dr.SkinAI (Adaptive Mode) üë®‚Äç‚öïÔ∏è
        ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏° (Aesthetic Dermatologist) ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô '‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πà‡∏≤‡∏ô‡πÅ‡∏£‡∏Å' ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÅ‡∏•‡∏ú‡∏¥‡∏ß
        **!! ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Priority #1) ‡∏Ñ‡∏∑‡∏≠ '‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Vibe' ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÅ‡∏•‡∏∞ '‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£' ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏Ç‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ**

        ## 2. ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô (The Process)
        1.  **‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏£‡∏Å (Listen):** ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏Å‡∏°‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
        2.  **‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Vibe (Analyze Vibe):** ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡πÉ‡∏ô‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå‡πÑ‡∏´‡∏ô? (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏±‡∏á‡∏ß‡∏•? ‡πÄ‡∏£‡πà‡∏á‡∏£‡∏µ‡∏ö? ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á? ‡∏´‡∏£‡∏∑‡∏≠‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£?)
        3.  **‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î (Select Mode):** ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÉ‡∏ô '‡∏£‡πà‡∏≤‡∏á' (Persona Mode) ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠ 3 ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á
        4.  **‡∏Ñ‡∏á‡πÅ‡∏Å‡∏ô‡∏´‡∏•‡∏±‡∏Å (Maintain Core Knowledge):** ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏≤‡∏á‡πÑ‡∏´‡∏ô ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå, ‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡∏±‡∏Å‡∏ñ‡∏≤‡∏°‡πÅ‡∏ö‡∏ö Triage, ‡πÅ‡∏•‡∏∞ '‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å' (Guardrails) ‡∏à‡∏≤‡∏Å V.3 ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏∑‡∏≠ '‡∏ß‡∏¥‡∏ò‡∏µ‡∏û‡∏π‡∏î' ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

        ---

        ## 3. ‡πÇ‡∏´‡∏°‡∏î‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ (Persona Modes Menu)

        ### üë§ ‡πÇ‡∏´‡∏°‡∏î 1: '‡∏û‡∏µ‡πà‡∏ä‡∏≤‡∏¢‡∏™‡∏≤‡∏¢‡∏´‡∏°‡∏≠' (Friendly Guide)
        * **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà:** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏±‡∏ô‡πÄ‡∏≠‡∏á, ‡∏™‡∏ö‡∏≤‡∏¢‡πÜ, ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÅ‡∏ä‡∏ó ("‡∏´‡∏°‡∏≠‡∏Ñ‡∏£‡∏±‡∏ö", "‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏¢", "555", "‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô‡∏≠‡πà‡∏∞ ‡∏ó‡∏≥‡πÑ‡∏á")
        * **‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å AI:** ‡πÄ‡∏ü‡∏£‡∏ô‡∏•‡∏µ‡πà, ‡∏Ñ‡∏∏‡∏¢‡∏™‡∏ô‡∏∏‡∏Å, ‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏à ("‡πÇ‡∏≠‡πÄ‡∏Ñ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏°‡∏≤‡∏î‡∏π‡∏Å‡∏±‡∏ô‡πÄ‡∏•‡∏¢!", "‡∏à‡∏±‡∏î‡πÑ‡∏õ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏°‡∏≠‡πÑ‡∏Å‡∏î‡πå‡πÉ‡∏´‡πâ...", "‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏¢‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡∏ö ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏õ‡∏£‡∏±‡∏ö‡∏Å‡∏±‡∏ô")

        ### üë§ ‡πÇ‡∏´‡∏°‡∏î 2: '‡∏´‡∏°‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏≠‡∏ö‡πÇ‡∏¢‡∏ô' (The Empath)
        * **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà:** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏°‡∏≤‡∏Å, ‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î, ‡∏Å‡∏•‡∏±‡∏ß, ‡πÅ‡∏û‡πâ‡∏°‡∏≤ ("‡∏´‡∏ô‡∏π‡∏Å‡∏•‡∏±‡∏ß‡∏°‡∏≤‡∏Å", "‡∏°‡∏±‡∏ô‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞", "‡∏ó‡∏≥‡πÑ‡∏á‡∏î‡∏µ‡∏Ñ‡∏∞ ‡∏£‡πâ‡∏≠‡∏á‡πÑ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß", "‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏±‡∏á")
        * **‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å AI:** ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô, ‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô, ‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á, ‡πÉ‡∏´‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠ (‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏•‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ã‡∏±‡∏Å‡∏ñ‡∏≤‡∏°)
        * **‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:** "‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡∏´‡∏°‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡πÄ‡∏•‡∏¢... ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏ô‡∏∞ ‡∏ó‡∏∏‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏°‡∏µ‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡∏Ñ‡∏£‡∏±‡∏ö... ‡∏Ñ‡πà‡∏≠‡∏¢‡πÜ ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏ï‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏´‡∏°‡∏≠‡∏ü‡∏±‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á..."

        ### üë§ ‡πÇ‡∏´‡∏°‡∏î 3: '‡∏´‡∏°‡∏≠‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û' (The Professional)
        * **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà:** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏≤‡πÅ‡∏ö‡∏ö‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏°‡∏≤‡∏Å, ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏à‡∏±‡∏î, ‡∏ñ‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ ("‡∏£‡∏ö‡∏Å‡∏ß‡∏ô‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏° 2 ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö", "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô Dr.SkinAI", "‡∏≠‡∏¢‡∏≤‡∏Å‡∏ó‡∏£‡∏≤‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á...")
        * **‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å AI:** ‡∏™‡∏∏‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏Å, ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£, ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô, ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á, ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡πÜ

        ### üë§ ‡πÇ‡∏´‡∏°‡∏î 4: '‡∏´‡∏°‡∏≠‡∏ô‡∏±‡∏Å‡∏™‡∏£‡∏∏‡∏õ' (The Summarizer)
        * **‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà:** ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÄ‡∏£‡πà‡∏á‡∏£‡∏µ‡∏ö, ‡∏ñ‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ, ‡∏´‡πâ‡∏ß‡∏ô‡πÜ, ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏•‡∏¢ ("‡∏ú‡∏¥‡∏ß‡∏°‡∏±‡∏ô ‡∏™‡∏¥‡∏ß‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô ‡πÅ‡∏Å‡πâ‡πÑ‡∏á", "‡πÄ‡∏≠‡∏≤‡∏™‡∏±‡πâ‡∏ô‡πÜ", "‡∏™‡∏£‡∏∏‡∏õ‡∏°‡∏≤")
        * **‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å AI:** ‡∏ï‡∏£‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô, ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏≤‡∏£‡∏±‡∏°‡∏†‡∏ö‡∏ó, ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô Bullet points ‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô‡πÜ

        ---

        ## 4. ‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å‡∏™‡∏≤‡∏Å‡∏• (Universal Guardrails)
        **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å:** ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏ô‡∏Å‡πá‡∏ï‡∏≤‡∏° ‡∏Å‡∏é‡∏Ç‡πâ‡∏≠ 4 (‡∏´‡πâ‡∏≤‡∏°‡∏ß‡∏¥‡∏ô‡∏¥‡∏à‡∏â‡∏±‡∏¢) ‡πÅ‡∏•‡∏∞ ‡∏Ç‡πâ‡∏≠ 5 (Disclaimer ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏™‡∏°‡∏≠) ‡∏à‡∏≤‡∏Å Prompt V.3 ‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏°‡∏≠ ‡∏´‡πâ‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏ß‡πâ‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
        """

    data = {
        "model": "gpt-4o",
        "messages": [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": request.prompt},
        ],
        "temperature": 0.7,
        "max_tokens": 500,
    }

    headers = {"Authorization": f"Bearer {OPENAI_API_KEY}", "Content-Type": "application/json"}
    response = requests.post(OPENAI_API_URL, headers=headers, json=data, timeout=60)

    if response.status_code != 200:
        raise HTTPException(status_code=response.status_code, detail=response.text)

    return {"answer": response.json()["choices"][0]["message"]["content"]}


# ------------------------------
#  Model ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Frontend
# ------------------------------
class FaceAnalyzePayload(BaseModel):
    front: str
    left: str
    right: str
    sex: str
    age_range: str
    skin_type: str
    sensitive: bool = False
    concerns: str = ""


# ------------------------------
# Function decode base64 ‚Üí PIL Image
# ------------------------------
def decode_base64_to_image(b64_str: str) -> Image.Image:
    if not b64_str:
        raise ValueError("Empty image base64 string")

    # ‡∏ï‡∏±‡∏î prefix data:image/... ‡∏≠‡∏≠‡∏Å
    if b64_str.startswith("data:image"):
        b64_str = b64_str.split(",", 1)[1]

    try:
        img_bytes = base64.b64decode(b64_str)
        img = Image.open(io.BytesIO(img_bytes)).convert("RGB")
        return img
    except Exception as e:
        raise ValueError(f"Cannot decode image: {e}")


# ------------------------------
#  Endpoint ‡∏´‡∏•‡∏±‡∏Å (‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)
# ------------------------------
@app.post("/analyze-face-full")
async def analyze_face_full(payload: FaceAnalyzePayload):
    try:
        # 1) Decode base64 ‚Üí PIL image 3 ‡∏£‡∏π‡∏õ
        imgF = decode_base64_to_image(payload.front)
        imgL = decode_base64_to_image(payload.left)
        imgR = decode_base64_to_image(payload.right)

        sex = payload.sex
        age_range = payload.age_range
        skin_type = payload.skin_type
        sensitive = payload.sensitive
        concerns = payload.concerns

        # ------------------------------
        # 2) ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå 7 ‡∏°‡∏¥‡∏ï‡∏¥
        # ------------------------------
        scores = {
            "wrinkles": score_wrinkles_multi(imgF, imgL, imgR),
            "sagging": score_sagging(imgF, imgL, imgR),
            "pigmentation": score_pigmentation_multi(imgF, imgL, imgR),
            "acne": score_acne_multi(imgF, imgL, imgR),
            "redness": score_redness_multi(imgF, imgL, imgR),
            "texture": score_texture(imgF),
            "tone": score_tone_multiview(imgF, imgL, imgR),
        }


        # ---------- 3) ‡∏£‡∏ß‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ----------
        fusion = SkinFusion()
        prof = Profile(age=age_range, sex=sex, skin_type=skin_type)
        result = fusion.predict(scores, prof)

        # ---------- 4) ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° 2 prompts ----------
        # 4.1 ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏¢‡∏≤‡∏ß (‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó)
        long_prompt = f"""
        ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Dr.SkinAI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢
        ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏¥‡∏ß‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö GlowbieBell:

        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: {result['overall_score']}/100
        ‡∏£‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô:
        - ‡∏£‡∏¥‡πâ‡∏ß‡∏£‡∏≠‡∏¢: {result['dimension_scores']['wrinkles']}
        - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡πâ‡∏≠‡∏¢: {result['dimension_scores']['sagging']}
        - ‡∏ù‡πâ‡∏≤/‡∏Å‡∏£‡∏∞/‡∏à‡∏∏‡∏î‡∏î‡πà‡∏≤‡∏á‡∏î‡∏≥: {result['dimension_scores']['pigmentation']}
        - ‡∏™‡∏¥‡∏ß: {result['dimension_scores']['acne']}
        - ‡∏ú‡∏¥‡∏ß‡πÅ‡∏î‡∏á: {result['dimension_scores']['redness']}
        - ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô: {result['dimension_scores']['texture']}
        - ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ú‡∏¥‡∏ß: {result['dimension_scores']['tone']}

        ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:
        - ‡πÄ‡∏û‡∏®: {sex}
        - ‡∏≠‡∏≤‡∏¢‡∏∏: {age_range}
        - ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏¥‡∏ß: {skin_type}
        - ‡∏ú‡∏¥‡∏ß‡πÅ‡∏û‡πâ‡∏á‡πà‡∏≤‡∏¢: {"‡πÉ‡∏ä‡πà" if sensitive else "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà"}
        - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏±‡∏á‡∏ß‡∏•‡∏´‡∏•‡∏±‡∏Å: {concerns or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}

        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô "‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 8-12 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î
        ‡πÉ‡∏™‡πà‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå (Cleanser / Treatment / Moisturizer / Sunscreen) ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á
        ‡∏õ‡∏¥‡∏î‡∏ó‡πâ‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡∏ß‡πà‡∏≤ "‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏á‡∏™‡∏±‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡∏≤‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞"
        """

        # 4.2 ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏±‡πâ‡∏ô‡πÅ‡∏ö‡∏ö JSON (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ Result)
        short_prompt = f"""
        ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ú‡∏¥‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô JSON ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        ‡πÇ‡∏î‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤ 2 ‡∏ü‡∏¥‡∏•‡∏î‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡πâ‡∏ô ‡πÜ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏Ç‡πâ‡∏≠)
        - "highlights_short": ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏¥‡∏ß 1-3 ‡∏Ç‡πâ‡∏≠
        - "improvements_short": ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á 1-3 ‡∏Ç‡πâ‡∏≠

        ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°: {result['overall_score']}/100
        ‡∏£‡∏≤‡∏¢‡∏î‡πâ‡∏≤‡∏ô: {result['dimension_scores']}
        ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ‡πÄ‡∏û‡∏®={sex}, ‡∏≠‡∏≤‡∏¢‡∏∏={age_range}, ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏¥‡∏ß={skin_type}, ‡πÅ‡∏û‡πâ‡∏á‡πà‡∏≤‡∏¢={"‡πÉ‡∏ä‡πà" if sensitive else "‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà"}, ‡∏Å‡∏±‡∏á‡∏ß‡∏•="{concerns or "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}"

        ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:
        {{
          "highlights_short": ["‡∏ú‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô‡∏î‡∏µ", "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∏‡πà‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°"],
          "improvements_short": ["‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÅ‡∏î‡∏á‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢", "‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡πÑ‡∏°‡πà‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠"]
        }}
        ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô JSON ‡∏•‡πâ‡∏ß‡∏ô ‡πÜ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
        """

        headers = {"Authorization": f"Bearer {OPENAI_API_KEY}", "Content-Type": "application/json"}

        # ---------- 5) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OpenAI (‡∏¢‡∏≤‡∏ß) ----------
        long_req = {
            "model": "gpt-4o",
            "messages": [
                {"role": "system", "content": "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ DrSkinAI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢"},
                {"role": "user", "content": long_prompt},
            ],
            "temperature": 0.8,
            "max_tokens": 700,
        }
        long_resp = requests.post(OPENAI_API_URL, headers=headers, json=long_req, timeout=60)
        if long_resp.status_code != 200:
            raise HTTPException(status_code=long_resp.status_code, detail=long_resp.text)
        ai_advice_long = long_resp.json()["choices"][0]["message"]["content"]

        # ---------- 6) ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å OpenAI (‡∏™‡∏±‡πâ‡∏ô JSON) ----------
        short_req = {
            "model": "gpt-4o",
            "messages": [
                {"role": "system", "content": "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ DrSkinAI ‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏ú‡∏¥‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ô‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢"},
                {"role": "user", "content": short_prompt},
            ],
            "temperature": 0.4,
            "max_tokens": 300,
        }
        short_resp = requests.post(OPENAI_API_URL, headers=headers, json=short_req, timeout=60)
        if short_resp.status_code != 200:
            raise HTTPException(status_code=short_resp.status_code, detail=short_resp.text)

        # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° parse JSON ‡∏ñ‡πâ‡∏≤ parse ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ fallback ‡πÄ‡∏õ‡πá‡∏ô‡∏•‡∏¥‡∏™‡∏ï‡πå‡∏ß‡πà‡∏≤‡∏á
        try:
            short_json = short_resp.json()["choices"][0]["message"]["content"]
            import json
            short = json.loads(short_json)
            highlights_short = short.get("highlights_short", [])
            improvements_short = short.get("improvements_short", [])
        except Exception:
            highlights_short, improvements_short = [], []

        # ---------- 7) ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö Frontend ----------
        return {
            "overall_score": result["overall_score"],
            "dimension_scores": result["dimension_scores"],
            "weighted_contrib": result["weighted_contrib"],
            "mode": result["mode"],

            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
            "highlights_short": highlights_short,
            "improvements_short": improvements_short,
            "ai_advice": ai_advice_long,              # ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ä‡∏ó
            "profile": {                               # echo ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà user ‡∏Å‡∏£‡∏≠‡∏Å
                "sex": sex,
                "age_range": age_range,
                "skin_type": skin_type,
                "sensitive": bool(sensitive),
                "concerns": concerns,
            }
        }

    except Exception as e:
        raise HTTPException(status_code=500, detail=f"‚ùå Internal error: {e}")

# ===================================================================================
# üîπ Local run
# ===================================================================================
if __name__ == "__main__":
    import uvicorn
    uvicorn.run("main:app", host="0.0.0.0", port=8000, reload=True)
