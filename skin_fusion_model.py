# ===================================================================================================
# skin_fusion_model.py  ‚Äî  GlowbieBell Fusion Calculator
# ---------------------------------------------------------------------------------------------------
# ‚úÖ ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 7 ‡∏ï‡∏±‡∏ß‡∏à‡∏≤‡∏Å AI ‡πÅ‡∏•‡πâ‡∏ß (0‚Äì1, ‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å = ‡∏ú‡∏¥‡∏ß‡πÅ‡∏¢‡πà)
# ‚úÖ ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ (1 - risk) ‚Üí health
# ‚úÖ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (overall 0‚Äì100) ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏°‡∏¥‡∏ï‡∏¥ (dimension 0‚Äì100)
# ‚úÖ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏Å‡πá‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
# ===================================================================================================

from dataclasses import dataclass
from typing import Dict, Any, Optional

# ---------------------------------------------------------------------------------------------------
# üß≠ ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå (‡∏ú‡∏¥‡∏ß‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢)
# ---------------------------------------------------------------------------------------------------
ASIAN_BASE_WEIGHTS = {
    "wrinkles":     0.20,   # ‡∏£‡∏¥‡πâ‡∏ß‡∏£‡∏≠‡∏¢
    "sagging":      0.18,   # ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏¢‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡πâ‡∏≠‡∏¢
    "pigmentation": 0.20,   # ‡∏ù‡πâ‡∏≤/‡∏Å‡∏£‡∏∞/‡∏à‡∏∏‡∏î‡∏î‡πà‡∏≤‡∏á‡∏î‡∏≥
    "acne":         0.18,   # ‡∏™‡∏¥‡∏ß
    "redness":      0.10,   # ‡∏ú‡∏¥‡∏ß‡πÅ‡∏î‡∏á
    "texture":      0.08,   # ‡∏ú‡∏¥‡∏ß‡πÄ‡∏£‡∏µ‡∏¢‡∏ö/‡∏£‡∏π‡∏Ç‡∏∏‡∏°‡∏Ç‡∏ô
    "tone":         0.06,   # ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠‡πÇ‡∏ó‡∏ô‡∏ú‡∏¥‡∏ß
}

# ---------------------------------------------------------------------------------------------------
# üë©‚Äç‚öïÔ∏è ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï)
# ---------------------------------------------------------------------------------------------------
@dataclass
class Profile:
    age: Optional[int] = None
    sex: Optional[str] = None
    skin_type: Optional[str] = None

# ---------------------------------------------------------------------------------------------------
# üîß Utility
# ---------------------------------------------------------------------------------------------------
def _clip01(x: float) -> float:
    return float(max(0.0, min(1.0, x)))

def _risk_to_health(score01: float) -> float:
    """‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á (0=‡∏î‡∏µ,1=‡πÅ‡∏¢‡πà) ‚Üí ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ú‡∏¥‡∏ß (0=‡πÅ‡∏¢‡πà,1=‡∏î‡∏µ)"""
    return 1.0 - _clip01(score01)

def _to_percent(x: float) -> float:
    return round(_clip01(x) * 100, 1)

# ---------------------------------------------------------------------------------------------------
# üåà SkinFusion Class
# ---------------------------------------------------------------------------------------------------
class SkinFusion:
    def __init__(self):
        print("üßÆ GlowbieBell Fusion: Using simple weighted formula (no model file)")

    def predict(self, ai_scores: Dict[str, float], profile: Optional[Profile] = None) -> Dict[str, Any]:
        """
        ai_scores: dict ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å AI (0‚Äì1, ‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å = ‡∏ú‡∏¥‡∏ß‡πÅ‡∏¢‡πà)
        ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤:
          - overall_score (0‚Äì100)
          - dimension_scores (0‚Äì100 ‡∏ï‡πà‡∏≠‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå)
          - weighted_contrib (‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ú‡∏•‡∏£‡∏ß‡∏°)
        """
        # ---- ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô health (‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å = ‡∏ú‡∏¥‡∏ß‡∏î‡∏µ) ----
        health_scores = {k: _risk_to_health(ai_scores.get(k, 0)) for k in ASIAN_BASE_WEIGHTS.keys()}

        # ---- ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Weighted Average) ----
        total_w = sum(ASIAN_BASE_WEIGHTS.values())
        weighted_sum = sum(ASIAN_BASE_WEIGHTS[k] * health_scores[k] for k in health_scores)
        overall = weighted_sum / total_w  # 0‚Äì1

        # ---- ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (0‚Äì100) ----
        overall_percent = _to_percent(overall)
        dim_percent = {k: _to_percent(v) for k, v in health_scores.items()}

        # ---- ‡∏´‡∏≤‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏µ‡∏ú‡∏• ----
        weighted_contrib = {
            k: round((ASIAN_BASE_WEIGHTS[k] * health_scores[k]) / total_w, 4)
            for k in health_scores
        }

        return {
            "overall_score": overall_percent,
            "dimension_scores": dim_percent,
            "weighted_contrib": weighted_contrib,
            "mode": "reverse_from_ai"
        }

# ---------------------------------------------------------------------------------------------------
# üß™ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
# ---------------------------------------------------------------------------------------------------
if __name__ == "__main__":
    # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà AI ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏î‡πâ (0‚Äì1, ‡∏¢‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏Å = ‡∏ú‡∏¥‡∏ß‡πÅ‡∏¢‡πà)
    ai_result = {
        "wrinkles": 0.65,
        "sagging": 0.45,
        "pigmentation": 0.80,
        "acne": 0.55,
        "redness": 0.30,
        "texture": 0.40,
        "tone": 0.25,
    }

    fusion = SkinFusion()
    result = fusion.predict(ai_result)

    print("\n=== GLOWBIEBELL FUSION RESULT ===")
    print(f"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏° (Overall): {result['overall_score']}/100")
    print("‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏≤‡∏¢‡∏°‡∏¥‡∏ï‡∏¥ (Dimension):")
    for k, v in result["dimension_scores"].items():
        print(f"  - {k}: {v}")
    print("Weighted Contribution:", result["weighted_contrib"])
